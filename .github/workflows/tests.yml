name: Tests & Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint & Code Quality
    runs-on: ubuntu-latest
    steps:
    - name: Free up disk space
      run: |
        echo "Freeing up disk space before checkout..."
        sudo rm -rf /usr/local/lib/android || true
        sudo rm -rf /usr/share/dotnet || true
        sudo rm -rf /opt/ghc || true
        sudo rm -rf /opt/hostedtoolcache/Python* || true
        df -h
    
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install black==24.1.1 flake8==7.0.0 mypy==1.8.0 pylint==3.0.3
    
    - name: Run Black formatter check
      run: |
        black --check --diff src/anomaly src/classifier src/memory_engine src/state_machine src/core
      continue-on-error: true
    
    - name: Run Flake8 linter
      run: |
        flake8 src/anomaly src/classifier src/memory_engine src/state_machine src/core \
          --max-line-length=100 --count --show-source --statistics
      continue-on-error: true
    
    - name: Run MyPy type checker
      run: |
        mypy src/anomaly src/classifier src/memory_engine src/state_machine src/core \
          --ignore-missing-imports --warn-unused-ignores
      continue-on-error: true

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
    - name: Free up disk space
      run: |
        echo "Freeing up disk space before checkout..."
        sudo rm -rf /usr/local/lib/android || true
        sudo rm -rf /usr/share/dotnet || true
        sudo rm -rf /opt/ghc || true
        sudo rm -rf /opt/hostedtoolcache/Python* || true
        df -h
    
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit==1.7.7 safety==2.3.5
    
    - name: Run Bandit security check
      run: |
        bandit -r src/anomaly src/classifier src/memory_engine src/state_machine src/core -f json -o bandit-report.json
    
    - name: Run Safety check
      run: |
        safety check --file=src/config/requirements.txt
        safety check --file=src/config/requirements-dev.txt

  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        python-version: ['3.11']
      fail-fast: false
    services:
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
      rabbitmq:
        image: rabbitmq:3.12-management-alpine
        env:
          RABBITMQ_DEFAULT_USER: guest
          RABBITMQ_DEFAULT_PASS: guest
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd "rabbitmq-diagnostics ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --name astra-event-bus
    
    steps:
    - name: Free up disk space
      run: |
        echo "Freeing up disk space before checkout..."
        sudo rm -rf /usr/local/lib/android || true
        sudo rm -rf /usr/share/dotnet || true
        sudo rm -rf /opt/ghc || true
        sudo rm -rf /opt/hostedtoolcache/Python* || true
        df -h
    
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r src/config/requirements.txt --extra-index-url https://download.pytorch.org/whl/cpu
        pip install -r src/config/requirements-test.txt

    - name: Print Environment Info
      run: |
        python --version
        pip freeze
        env

    - name: Create .env file
      run: cp infra/docker/.env.example infra/docker/.env

    - name: Start Docker Stack
      run: |
        docker compose -f infra/docker/docker-compose.ci.yml up -d --build
        docker compose -f infra/docker/docker-compose.ci.yml ps

    - name: Debug Redis URL
      run: echo "REDIS_URL=$REDIS_URL"
    
    - name: Wait for Redis
      run: |
        for i in {1..60}; do
          redis-cli -h localhost -p 6379 ping && break
          echo "Waiting for Redis..."
          sleep 1
        done

    - name: Verify Redis Connectivity
      run: |
        redis-cli -h localhost -p 6379 ping
    
    - name: Run pytest with coverage
      env:
        REDIS_URL: redis://localhost:6379
        ASTRA_CONSOLE_LOGGING: 'true'
      run: |
        pytest tests/ \
          -v \
          -o log_cli=true \
          -o log_cli_level=INFO \
          --cov=src/anomaly \
          --cov=src/classifier \
          --cov=src/memory_engine \
          --cov=src/state_machine \
          --cov=src/core \
          --cov-report=term-missing \
          --cov-report=xml \
          --timeout=30 \
          --tb=short
    
    - name: Check coverage threshold
      run: coverage report --fail-under=70
    
    - name: Capture Docker Logs
      if: failure()
      run: |
        docker compose -f infra/docker/docker-compose.ci.yml logs --no-color > docker-logs.txt

    - name: Capture Container Status
      if: failure()
      run: docker ps -a > docker-status.txt

    - name: Capture Health Status
      if: failure()
      run: |
        if [ -n "$(docker ps -q)" ]; then
          docker inspect $(docker ps -q) --format='{{.Name}} - {{.State.Health.Status}}' > health-status.txt
        else
          echo "No running containers" > health-status.txt
        fi

    - name: Capture Environment Info
      if: failure()
      run: |
        env > environment.txt
        docker version >> environment.txt
        docker compose version >> environment.txt

    - name: Upload debug artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ci-debug-logs
        path: |
          docker-logs.txt
          docker-status.txt
          health-status.txt
          environment.txt

    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report-python${{ matrix.python-version }}
        path: htmlcov/
        retention-days: 30
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      if: always()
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
    
    - name: Clean up pip cache
      if: always()
      run: pip cache purge

  test-matrix:
    name: Test (Python ${{ matrix.python-version }}) - Extended
    runs-on: ubuntu-latest
    needs: test
    if: |
      github.event_name == 'pull_request' || 
      github.ref == 'refs/heads/develop'
    strategy:
      matrix:
        python-version: ['3.9', '3.12', '3.13']
      fail-fast: false
    services:
      rabbitmq:
        image: rabbitmq:3.12-management-alpine
        env:
          RABBITMQ_DEFAULT_USER: guest
          RABBITMQ_DEFAULT_PASS: guest
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd "rabbitmq-diagnostics ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --name astra-event-bus
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    env:
      REDIS_URL: redis://localhost:6379

    steps:
    - name: Free up disk space
      run: |
        echo "Freeing up disk space before checkout..."
        sudo rm -rf /usr/local/lib/android || true
        sudo rm -rf /usr/share/dotnet || true
        sudo rm -rf /opt/ghc || true
        sudo rm -rf /opt/hostedtoolcache/Python* || true
        df -h
    
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r src/config/requirements.txt --extra-index-url https://download.pytorch.org/whl/cpu
        pip install -r src/config/requirements-test.txt

    - name: Print Environment Info
      run: |
        python --version
        pip freeze
        env

    - name: Debug Redis URL
      run: echo "REDIS_URL=$REDIS_URL"
    
    - name: Wait for Redis
      run: |
        for i in {1..60}; do
          redis-cli -h localhost -p 6379 ping && break
          echo "Waiting for Redis..."
          sleep 1
        done

    - name: Verify Redis Connectivity
      run: |
        redis-cli -h localhost -p 6379 ping
    
    - name: Run pytest
      run: |
        pytest tests/ \
          -vv --maxfail=1 --durations=10 --log-cli-level=DEBUG \
          --cov=src/anomaly \
          --cov=src/classifier \
          --cov=src/memory_engine \
          --cov=src/state_machine \
          --cov=src/core \
          --cov-report=xml \
          --timeout=30 \
          --tb=short
    
    - name: Clean up pip cache
      if: always()
      run: pip cache purge
