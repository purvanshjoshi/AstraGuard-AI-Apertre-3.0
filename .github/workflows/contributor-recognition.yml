name: Update Contributor Recognition

on:
  # Run weekly on Sundays at midnight UTC
  schedule:
    - cron: '0 0 * * 0'
  
  # Allow manual trigger
  workflow_dispatch:
  
  # Run when PRs are merged to main
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  update-contributors:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests pyyaml
      
      - name: Generate contributor report
        id: generate
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/maintenance/update_contributors.py \
            --repo ${{ github.repository }} \
            --token ${{ secrets.GITHUB_TOKEN }} \
            --json
      
      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet contributor_report.json; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit and push if changed
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add contributor_report.json
          git commit -m "chore: update contributor recognition data [skip ci]"
          git push
      
      - name: Upload report artifact
        uses: actions/upload-artifact@v3
        with:
          name: contributor-report
          path: contributor_report.json
          retention-days: 90

  welcome-new-contributors:
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    permissions:
      pull-requests: write
      issues: write
    
    steps:
      - name: Check if first-time contributor
        id: check_first_time
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const author = context.payload.pull_request.user.login;
            const repo = context.repo;
            
            // Check for previous merged PRs
            const { data: pullRequests } = await github.rest.search.issuesAndPullRequests({
              q: `repo:${repo.owner}/${repo.repo} type:pr author:${author} is:merged`,
            });
            
            const isFirstContribution = pullRequests.total_count === 1;
            core.setOutput('is_first_time', isFirstContribution);
            core.setOutput('pr_count', pullRequests.total_count);
            return isFirstContribution;
      
      - name: Welcome first-time contributor
        if: steps.check_first_time.outputs.is_first_time == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const welcomeMessage = `
            ## ğŸ‰ Welcome to AstraGuard AI! ğŸ‰
            
            Congratulations @${{ github.event.pull_request.user.login }} on your first merged pull request!
            
            You've officially joined our community of contributors! ğŸŒ±
            
            ### What's Next?
            
            - ğŸ† You've earned the **New Contributor** badge!
            - ğŸ“‹ You're now listed in our [CONTRIBUTORS.md](https://github.com/${{ github.repository }}/blob/main/CONTRIBUTORS.md)
            - ğŸ¯ Check out more [good-first-issues](https://github.com/${{ github.repository }}/labels/good-first-issue) to continue contributing
            - ğŸ“– Learn about our [Recognition Program](https://github.com/${{ github.repository }}/blob/main/.github/CONTRIBUTOR_RECOGNITION.md)
            
            ### Recognition Tiers
            - â­ **Active Contributor** (2-4 PRs) - Your next milestone!
            - ğŸ’ **Regular Contributor** (5-19 PRs)
            - ğŸŒŸ **Core Contributor** (20-49 PRs)
            - ğŸ‘‘ **Legend** (50+ PRs)
            
            Thank you for making AstraGuard AI better! We're excited to see your continued contributions. ğŸš€
            
            If you have any questions or need help, feel free to ask in [GitHub Discussions](https://github.com/${{ github.repository }}/discussions).
            
            ---
            *This is an automated message from the AstraGuard AI contributor recognition system.*
            `;
            
            await github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: welcomeMessage
            });
      
      - name: Milestone achievement notification
        if: steps.check_first_time.outputs.is_first_time != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prCount = parseInt('${{ steps.check_first_time.outputs.pr_count }}');
            const milestones = {
              2: { tier: 'Active', emoji: 'â­', next: 'Regular (5 PRs)' },
              5: { tier: 'Regular', emoji: 'ğŸ’', next: 'Core (20 PRs)' },
              10: { tier: 'Getting Serious', emoji: 'ğŸ’ª', next: 'Core (20 PRs)' },
              20: { tier: 'Core', emoji: 'ğŸŒŸ', next: 'Legend (50 PRs)' },
              50: { tier: 'Legend', emoji: 'ğŸ‘‘', next: 'Keep going!' },
              100: { tier: 'LEGENDARY', emoji: 'ğŸ–ï¸', next: 'Amazing!' },
            };
            
            if (milestones[prCount]) {
              const milestone = milestones[prCount];
              const message = `
              ## ğŸ† Milestone Achievement Unlocked!
              
              Congratulations @${{ github.event.pull_request.user.login }}! This is your **${prCount}th** merged PR! ${milestone.emoji}
              
              You've reached the **${milestone.tier}** tier!
              
              ${prCount < 100 ? `ğŸ¯ Next milestone: ${milestone.next}` : ''}
              
              Thank you for your continued contributions to AstraGuard AI! ğŸš€
              
              ---
              *Automated milestone notification*
              `;
              
              await github.rest.issues.createComment({
                issue_number: context.payload.pull_request.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: message
              });
            }
